#!/bin/sh
# hw2pdf: compile all images in specified dir into a pdf
# Only works with jpg atm
#
# USAGE: 
# hw2pdf <images_directory>
# hw2pdf <images_directroy> <output.pdf>

set -e
set -u
#set -x # debugging

# Argument Check
if [ "$#" -lt 1 ]; then
    printf "USAGE:\n$(basename "$0") <images_directory>\n$(basename "$0") <images_directory> <output.pdf>\n" >&2
    exit 1
fi

# Check input directory
IMG_DIR="$1"
if [ ! -d "$IMG_DIR" ]; then
    echo "Error: '$IMG_DIR' is not a valid directory." >&2
    exit 1
fi

# Check output arg
OUTPUT='-'
[ $# -eq 2 ] && OUTPUT="$2"

# echo "Creating temporary directory..."
TEMP_DIR=$(mktemp -d)
# echo "$TEMP_DIR"
trap 'rm -r "$TEMP_DIR"' EXIT

# echo "Compressing images to temp dir..."
for img in "$IMG_DIR"/*.jpg; do
    FILENAME=$(basename "$img")
    if [ -f "$img" ]; then
	#ffmpeg -hide_banner -loglevel error -i "$img" -vf "scale=iw*0.75:ih*0.75" "$TEMP_DIR/$FILENAME"
	ffmpeg -hide_banner -loglevel error -i "$img" -q:v 10 "$TEMP_DIR/$FILENAME"
    fi
done

# echo "Compiling images to pdf..."
find "$TEMP_DIR" -maxdepth 1 -type f -print0 | sort -z | xargs -0 img2pdf --output "$OUTPUT"
# echo "Done. PDF saved to: $OUTPUT"
# echo "Deleting $TEMP_DIR"
